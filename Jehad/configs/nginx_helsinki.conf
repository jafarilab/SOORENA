# SOORENA Shiny Application - University of Helsinki
# Nginx Configuration for HTTPS Reverse Proxy to Shiny Server
#
# This configuration provides:
# - HTTPS access via SSL/TLS with certificates provided by Helsinki IT
# - Reverse proxy from HTTPS (port 443) to Shiny Server (port 3838)
# - WebSocket support (critical for Shiny interactivity)
# - Security headers and modern TLS configuration
# - HTTP to HTTPS redirect
#
# Installation:
# 1. Copy this file to /etc/nginx/sites-available/soorena
# 2. Update YOUR_DOMAIN.helsinki.fi with actual domain
# 3. Update certificate paths if different
# 4. Create symbolic link: sudo ln -s /etc/nginx/sites-available/soorena /etc/nginx/sites-enabled/
# 5. Test configuration: sudo nginx -t
# 6. Reload Nginx: sudo systemctl reload nginx

# ============================================================================
# HTTP to HTTPS Redirect
# ============================================================================
# All HTTP traffic (port 80) is redirected to HTTPS (port 443)
# This ensures all connections are encrypted

server {
    listen 80;
    listen [::]:80;
    server_name YOUR_DOMAIN.helsinki.fi;

    # Redirect all HTTP requests to HTTPS
    return 301 https://$server_name$request_uri;
}

# ============================================================================
# HTTPS Server Block
# ============================================================================
# Main server configuration handling HTTPS and proxying to Shiny Server

server {
    # Listen on HTTPS port with HTTP/2 support
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name YOUR_DOMAIN.helsinki.fi;

    # ------------------------------------------------------------------------
    # SSL Certificate Configuration
    # ------------------------------------------------------------------------
    # These certificates should be provided by Helsinki IT
    # Update paths if certificates are stored in a different location

    ssl_certificate /etc/ssl/helsinki/YOUR_DOMAIN.helsinki.fi.crt;
    ssl_certificate_key /etc/ssl/helsinki/YOUR_DOMAIN.helsinki.fi.key;

    # If IT provides a separate certificate chain file, uncomment and add:
    # ssl_trusted_certificate /etc/ssl/helsinki/YOUR_DOMAIN.helsinki.fi-chain.crt;

    # ------------------------------------------------------------------------
    # SSL Security Settings
    # ------------------------------------------------------------------------
    # Modern TLS configuration following current security best practices

    # Only allow secure TLS protocols (disable older SSL/TLS versions)
    ssl_protocols TLSv1.2 TLSv1.3;

    # Cipher suite configuration for strong encryption
    # These ciphers provide good security while maintaining compatibility
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384';

    # Let clients choose cipher preference (better compatibility)
    ssl_prefer_server_ciphers off;

    # SSL session caching for improved performance
    # 10 MB cache can store approximately 40,000 sessions
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # Enable OCSP stapling for faster certificate validation
    # Uncomment if your certificates support OCSP
    # ssl_stapling on;
    # ssl_stapling_verify on;

    # ------------------------------------------------------------------------
    # Security Headers
    # ------------------------------------------------------------------------
    # Additional security headers to protect against common web vulnerabilities

    # HSTS: Force HTTPS for 1 year (including subdomains)
    # Tells browsers to always use HTTPS for this domain
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # Prevent clickjacking: only allow framing from same origin
    add_header X-Frame-Options "SAMEORIGIN" always;

    # Prevent MIME type sniffing
    add_header X-Content-Type-Options "nosniff" always;

    # Enable XSS protection in browsers
    add_header X-XSS-Protection "1; mode=block" always;

    # Optional: Content Security Policy (uncomment and customize if needed)
    # add_header Content-Security-Policy "default-src 'self' 'unsafe-inline' 'unsafe-eval' data: https:;" always;

    # ------------------------------------------------------------------------
    # Logging Configuration
    # ------------------------------------------------------------------------
    # Separate logs for SOORENA application for easier troubleshooting

    access_log /var/log/nginx/soorena_access.log;
    error_log /var/log/nginx/soorena_error.log;

    # ------------------------------------------------------------------------
    # Root Location - Redirect to /soorena/
    # ------------------------------------------------------------------------
    # Accessing the root domain redirects to the Shiny application

    location = / {
        return 301 https://$server_name/soorena/;
    }

    # ------------------------------------------------------------------------
    # Main Application Proxy Location
    # ------------------------------------------------------------------------
    # Proxy HTTPS requests to Shiny Server running on port 3838
    # This is the critical configuration for making Shiny work with HTTPS

    location /soorena/ {
        # Proxy to Shiny Server on localhost port 3838
        # Shiny Server is not exposed to the internet - only via Nginx
        proxy_pass http://127.0.0.1:3838/soorena/;

        # Standard proxy headers to preserve client information
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # --------------------------------------------------------------------
        # WebSocket Support (CRITICAL FOR SHINY)
        # --------------------------------------------------------------------
        # Shiny uses WebSockets for real-time interactivity
        # Without these settings, the application will not work properly

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;

        # --------------------------------------------------------------------
        # Timeout Configuration
        # --------------------------------------------------------------------
        # Increased timeouts to accommodate:
        # - 247 MB database loading time (initial app startup)
        # - Long-running data filtering operations
        # - Large data table rendering

        # Time to wait for Shiny Server response (5 minutes)
        proxy_read_timeout 300s;

        # Time to establish connection to Shiny Server (75 seconds)
        proxy_connect_timeout 75s;

        # Time for client to send request (default 60s is usually fine)
        # client_body_timeout 60s;

        # --------------------------------------------------------------------
        # Buffering Configuration
        # --------------------------------------------------------------------
        # Disable buffering for real-time updates from Shiny
        # This ensures reactive updates are sent to the browser immediately
        proxy_buffering off;

        # Disable request buffering for large file uploads (if needed)
        proxy_request_buffering off;

        # --------------------------------------------------------------------
        # Upload Size Limit
        # --------------------------------------------------------------------
        # Maximum size for file uploads (adjust if your app needs file uploads)
        client_max_body_size 100M;

        # --------------------------------------------------------------------
        # Additional Headers
        # --------------------------------------------------------------------
        # Ensure cookies and authentication work properly
        proxy_set_header Cookie $http_cookie;

        # Preserve original request URI
        proxy_set_header X-Original-URI $request_uri;
    }

    # ------------------------------------------------------------------------
    # Static Files Optimization (Optional but Recommended)
    # ------------------------------------------------------------------------
    # Serve static assets (images, CSS, JS) directly from Nginx
    # This is more efficient than proxying to Shiny Server
    # Shiny Server stores static files in www/ directory

    location /soorena/www/ {
        # Path to static files on the server
        alias /srv/shiny-server/soorena/www/;

        # Cache static files for 1 year (they have cache-busting in filenames)
        expires 1y;
        add_header Cache-Control "public, immutable";

        # Security: don't allow directory listing
        autoindex off;

        # MIME types are handled automatically by Nginx
        # but you can add specific types if needed:
        # types {
        #     image/png png;
        #     image/jpeg jpg jpeg;
        # }
    }

    # ------------------------------------------------------------------------
    # Health Check Endpoint (Optional)
    # ------------------------------------------------------------------------
    # Simple endpoint to verify Nginx is responding
    # Useful for monitoring systems

    location /health {
        access_log off;
        return 200 "OK\n";
        add_header Content-Type text/plain;
    }
}

# ============================================================================
# WebSocket Upgrade Map
# ============================================================================
# This mapping is used to upgrade HTTP connections to WebSocket
# Required for the WebSocket support in the /soorena/ location

map $http_upgrade $connection_upgrade {
    default upgrade;
    '' close;
}

# ============================================================================
# Usage Notes:
# ============================================================================
#
# 1. PLACEHOLDERS TO REPLACE:
#    - YOUR_DOMAIN.helsinki.fi → actual domain name
#    - /etc/ssl/helsinki/YOUR_DOMAIN.helsinki.fi.crt → actual certificate path
#    - /etc/ssl/helsinki/YOUR_DOMAIN.helsinki.fi.key → actual key path
#
# 2. TESTING BEFORE DOMAIN IS AVAILABLE:
#    - Replace YOUR_DOMAIN.helsinki.fi with server IP address
#    - Example: server_name 123.45.67.89;
#    - SSL will show warnings but functionality will work
#    - Update to actual domain once available
#
# 3. CERTIFICATE VERIFICATION:
#    After updating certificate paths, verify they work:
#    sudo openssl x509 -in /etc/ssl/helsinki/YOUR_DOMAIN.helsinki.fi.crt -text -noout
#    sudo openssl rsa -in /etc/ssl/helsinki/YOUR_DOMAIN.helsinki.fi.key -check
#
# 4. CONFIGURATION TEST:
#    Always test before reloading:
#    sudo nginx -t
#
# 5. COMMON ISSUES:
#    - WebSocket not working: Check Upgrade and Connection headers
#    - Timeouts: Increase proxy_read_timeout and app_init_timeout
#    - SSL errors: Verify certificate paths and permissions (crt=644, key=600)
#    - 502 Bad Gateway: Check Shiny Server is running on port 3838
#
# ============================================================================
