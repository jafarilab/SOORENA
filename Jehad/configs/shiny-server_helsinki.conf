# Shiny Server Configuration for SOORENA Application
# University of Helsinki Deployment
#
# This configuration is optimized for:
# - 8GB RAM server
# - 247 MB SQLite database (predictions.db)
# - Multiple concurrent users
# - Production environment
#
# Installation:
# 1. Copy this file to /etc/shiny-server/shiny-server.conf
# 2. Test configuration: Check for syntax errors by starting Shiny Server
# 3. Restart Shiny Server: sudo systemctl restart shiny-server
# 4. Verify status: sudo systemctl status shiny-server
#
# Documentation: https://docs.posit.co/shiny-server/

# ============================================================================
# Server Configuration
# ============================================================================

# Run the Shiny Server process as the 'shiny' user
# Security: This prevents apps from running as root
run_as shiny;

# Preserve R environment variables when launching R sessions
# This ensures environment variables set by the user are available to apps
preserve_logs true;

# ============================================================================
# Server Settings
# ============================================================================

server {
  # Port that Shiny Server listens on
  # NOTE: This is INTERNAL ONLY - not exposed to the internet
  # Nginx reverse proxy forwards HTTPS traffic from port 443 to this port
  listen 3838;

  # Location of server access logs
  access_log /var/log/shiny-server/access.log;

  # Default site directory location (index of all apps)
  location / {
    site_dir /srv/shiny-server;

    # Directory index page settings
    # Shows a list of available applications
    directory_index on;

    # Default log directory for apps at this location
    log_dir /var/log/shiny-server;
  }

  # --------------------------------------------------------------------------
  # SOORENA Application Configuration
  # --------------------------------------------------------------------------
  # Specific configuration for the SOORENA application
  # This overrides default settings with optimized values for our use case

  location /soorena {
    # Path to the SOORENA application directory
    # Must contain app.R and supporting files (data/, www/)
    app_dir /srv/shiny-server/soorena;

    # Application-specific log directory
    # Logs for SOORENA will be written here
    log_dir /var/log/shiny-server;

    # ----------------------------------------------------------------------
    # Timeout Settings (CRITICAL FOR SOORENA)
    # ----------------------------------------------------------------------
    # These timeouts are increased to accommodate the 247 MB database

    # App initialization timeout (seconds)
    # Time allowed for app.R to load and initialize
    # SOORENA needs 60-120 seconds to:
    # - Load 11 R packages
    # - Open SQLite connection to 247 MB database
    # - Initialize UI and server components
    # Default is 60s, we increase to 120s for safety
    app_init_timeout 120;

    # App idle timeout (seconds)
    # Time before disconnecting idle user sessions
    # Higher value prevents premature disconnection during long operations
    # - Complex filtering operations can take 30-60 seconds
    # - Large data table rendering can take 20-40 seconds
    # Default is 5s, we increase to 600s (10 minutes)
    app_idle_timeout 600;

    # Session timeout (seconds)
    # Maximum time a session can remain connected
    # Set to 0 for unlimited (let Nginx handle timeout)
    # Or set to a reasonable value like 3600 (1 hour)
    # app_session_timeout 3600;

    # ----------------------------------------------------------------------
    # User Management
    # ----------------------------------------------------------------------
    # Run this specific app as the shiny user
    # Inherits from global run_as, but can be overridden here if needed
    # run_as shiny;

    # ----------------------------------------------------------------------
    # Resource Management
    # ----------------------------------------------------------------------
    # These settings control how Shiny Server manages R processes

    # Simple scheduler: one R process per user session
    # This is appropriate for applications with moderate resource usage
    # Alternative: 'utilization' scheduler for high-concurrency scenarios
    simple_scheduler 5;

    # The number 5 means: allow up to 5 concurrent sessions before queuing
    # With 8GB RAM, each session uses approximately:
    # - Base R: ~100 MB
    # - Loaded packages: ~200 MB
    # - Database in memory: ~300 MB
    # - Data filtering/operations: ~200 MB
    # - Total per session: ~800 MB
    # 5 sessions * 800 MB = 4 GB, leaving 4 GB for OS and overhead

    # ----------------------------------------------------------------------
    # Logging
    # ----------------------------------------------------------------------
    # Log verbosity (default is 'info')
    # Options: debug, info, warning, error
    # Set to 'debug' for troubleshooting, 'info' for production
    # log_level info;
  }
}

# ============================================================================
# Additional Notes
# ============================================================================
#
# SCALING RECOMMENDATIONS:
# ========================
# If you need to support more concurrent users:
#
# 1. Increase simple_scheduler value:
#    - 10 users: simple_scheduler 10; (requires ~8 GB RAM minimum)
#    - 20 users: simple_scheduler 20; (requires ~16 GB RAM)
#
# 2. Monitor memory usage:
#    free -h
#    ps aux | grep R
#
# 3. Consider switching to utilization scheduler for better resource sharing:
#    utilization_scheduler 0.8;  # Target 80% CPU utilization
#
# 4. Add connection limits:
#    max_connections 50;  # Maximum total connections
#
# TIMEOUT TROUBLESHOOTING:
# ========================
# If users experience timeouts:
#
# 1. Increase app_init_timeout (if app fails to load):
#    app_init_timeout 180;  # 3 minutes
#
# 2. Increase app_idle_timeout (if sessions disconnect during use):
#    app_idle_timeout 900;  # 15 minutes
#
# 3. Check logs for specific timeout errors:
#    sudo tail -f /var/log/shiny-server.log
#
# 4. Verify Nginx timeouts are also adequate:
#    proxy_read_timeout in /etc/nginx/sites-available/soorena
#
# MONITORING:
# ===========
# Check Shiny Server logs:
#   sudo tail -f /var/log/shiny-server.log
#   sudo tail -f /var/log/shiny-server/soorena-*.log
#
# Check active sessions:
#   ps aux | grep shiny
#
# Check port availability:
#   sudo netstat -tlnp | grep 3838
#   # or
#   sudo ss -tlnp | grep 3838
#
# Restart Shiny Server:
#   sudo systemctl restart shiny-server
#
# Check Shiny Server status:
#   sudo systemctl status shiny-server
#
# SECURITY NOTES:
# ===============
# - Port 3838 should NOT be exposed to the internet
# - Firewall should only allow access from localhost
# - Nginx handles external HTTPS access and forwards to this port
# - All R sessions run as non-root 'shiny' user for security
#
# FILE PERMISSIONS:
# =================
# Ensure proper ownership and permissions:
#   sudo chown -R shiny:shiny /srv/shiny-server/soorena
#   sudo chmod -R 755 /srv/shiny-server/soorena
#   sudo chmod 644 /srv/shiny-server/soorena/data/predictions.db
#
# DATABASE OPTIMIZATION:
# ======================
# For better performance with large database:
# 1. Ensure SQLite indexes exist (should be in predictions.db)
# 2. Consider using connection pooling in app.R
# 3. Monitor query performance with EXPLAIN QUERY PLAN in SQLite
#
# BACKUP CONFIGURATION:
# =====================
# Before modifying this file, always backup:
#   sudo cp /etc/shiny-server/shiny-server.conf /etc/shiny-server/shiny-server.conf.backup
#
# ============================================================================
